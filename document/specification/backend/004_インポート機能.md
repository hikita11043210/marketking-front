# マスターデータインポート機能仕様書

## 1. 概要
本機能は、配送料金マスター（FedEx、DHL、エコノミー）および国マスターをExcelファイルからインポートするための機能です。それぞれの配送業者の送料表フォーマットに対応したインポート処理を提供します。

## 2. 機能一覧
- FedEx送料マスターのインポート
- DHL送料マスターのインポート
- エコノミー送料マスターのインポート
- 国マスターのインポート

## 3. APIエンドポイント
- URL: `/api/master/import/`
- メソッド: POST
- 認証: 必須（JWT認証）
- パーサー: MultiPartParser, FormParser

## 4. リクエストパラメータ

### 4.1 共通パラメータ
| パラメータ名 | 型 | 必須 | 説明 |
|------------|-----|-----|-----|
| type | string | 必須 | インポートタイプ（'fedex', 'dhl', 'economy', 'countries'のいずれか） |
| file | file | 必須 | インポートするExcelファイル（.xlsx形式） |

### 4.2 エコノミー配送用パラメータ
| パラメータ名 | 型 | 必須 | 説明 |
|------------|-----|-----|-----|
| country_code | string | 必須 | 国コード（例: 'US', 'GB', 'DE', 'AU'など） |

## 5. レスポンス

### 5.1 正常時レスポンス
```json
{
  "success": true,
  "message": "XXX件のYYY送料データをインポートしました。",
  "data": {
    "count": 123
  }
}
```

### 5.2 エラー時レスポンス
```json
{
  "success": false,
  "message": "エラーメッセージ"
}
```

## 6. Excelファイル形式仕様

### 6.1 FedEx送料マスター (FedEx_2025.xlsx)
- **ゾーン情報**: C6〜M6 セル
- **重量情報**: B11〜B98 セル
- **送料情報**: C11〜X98 セル（ゾーン×重量の組み合わせ）

### 6.2 DHL送料マスター (DHL_2025.xlsx)
- **ゾーン情報**: C9〜X9 セル
- **重量情報**: B17〜B190 セル
- **送料情報**: C17〜M190 セル（ゾーン×重量の組み合わせ）
- **ファイル名**: ファイル名に 'doc' または 'document' を含む場合、書類区分として処理

### 6.3 エコノミー送料マスター
- **左側テーブル**:
  - **重量情報**: B10〜B42 セル
  - **送料情報**: C10〜C42 セル
- **右側テーブル**:
  - **重量情報**: D10〜D42 セル
  - **送料情報**: E10〜E42 セル
- **国指定**: APIリクエストの country_code パラメータで指定

### 6.4 国マスター
| カラム名 | 説明 |
|---------|-----|
| Code | 国コード（2文字） |
| Name | 国名 |
| ZoneFedex | FedExのゾーン番号 |
| ZoneDhl | DHLのゾーン番号 |
| ZoneEconomy | エコノミー配送のゾーン番号 |

## 7. 処理フロー

### 7.1 共通処理フロー
1. リクエストパラメータ（type, file）の検証
2. ファイル形式の検証（.xlsx形式のみ許可）
3. インポートタイプに応じた処理の実行
4. レスポンスの返却

### 7.2 各インポート処理の流れ
1. **データ削除処理**:
   - FedEx: 全データ削除
   - DHL: 書類/物品区分ごとに削除
   - Economy: 指定国のデータのみ削除
   - 国マスター: 全データ削除

2. **データ読み込み**:
   - Excelファイルをpandasで読み込み
   - 該当セル範囲からデータを抽出

3. **データ処理**:
   - 不正値や空値のチェック
   - 適切な型への変換（整数、小数）

4. **データ登録**:
   - トランザクション内でバルク登録
   - 1000件ごとに分割して登録処理を実行

## 8. エラーハンドリング
- パラメータ不足: 400 Bad Request
- ファイル形式不正: 400 Bad Request
- 処理中エラー: 500 Internal Server Error

## 9. セキュリティ
- 認証済みユーザーのみアクセス可能
- ファイル拡張子の検証

## 10. 制約事項
- .xlsx形式のファイルのみ対応
- 指定されたExcel構造に従ったデータのみ正しく処理
- 大量データのインポート時はメモリ使用量に注意

## 11. 使用例

### 11.1 FedExのインポート
```
POST /api/master/import/
{
  "type": "fedex",
  "file": [FedEx_2025.xlsx]
}
```

### 11.2 DHLのインポート
```
POST /api/master/import/
{
  "type": "dhl",
  "file": [DHL_2025.xlsx]
}
```

### 11.3 Economyのインポート（アメリカの場合）
```
POST /api/master/import/
{
  "type": "economy",
  "country_code": "US",
  "file": [エコノミー料金表.xlsx]
}
```

### 11.4 国マスターのインポート
```
POST /api/master/import/
{
  "type": "countries",
  "file": [国マスター.xlsx]
}
```
